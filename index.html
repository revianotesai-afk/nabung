<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menabung Bareng ðŸ’•</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', system-ui, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #ffebee, #f8d4e6);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }
    .container {
      background: white;
      border-radius: 22px;
      box-shadow: 0 8px 30px rgba(216, 27, 96, 0.2);
      width: 94%;
      max-width: 500px;
      padding: 24px;
      text-align: center;
    }
    h1 {
      color: #ad1457;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 700;
    }

    #total-banner {
      background: linear-gradient(90deg, #ec407a, #d81b60);
      color: white;
      padding: 14px;
      border-radius: 14px;
      margin: 0 auto 20px;
      width: 100%;
      font-size: 17px;
      font-weight: 700;
    }
    .total-amount {
      font-size: 21px;
      display: block;
      margin-top: 5px;
    }

    /* Persentase Kontribusi */
    .contributions {
      display: flex;
      justify-content: space-around;
      margin: 16px 0 22px;
      gap: 10px;
    }
    .contrib-card {
      background: #fdf6fa;
      border-radius: 14px;
      padding: 12px 8px;
      width: 48%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .contrib-name.mellycia { color: #1565c0; font-weight: 600; }
    .contrib-name.reviano { color: #7b1fa2; font-weight: 600; }
    .contrib-percent {
      font-size: 20px;
      font-weight: 700;
      margin: 4px 0;
    }
    .contrib-bar {
      height: 6px;
      background: #eee;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    .contrib-fill.mellycia { background: #42a5f5; height: 100%; }
    .contrib-fill.reviano { background: #ab47bc; height: 100%; }

    .user-select {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 26px;
    }
    .user-btn {
      background: #fde0e6;
      border: none;
      border-radius: 14px;
      padding: 13px 20px;
      font-size: 16px;
      font-weight: 600;
      color: #c2185b;
      cursor: pointer;
      width: 115px;
    }
    .user-btn.active {
      background: #d81b60;
      color: white;
    }

    .saving-ui { display: none; }
    .header-user {
      font-size: 20px;
      color: #ad1457;
      margin-bottom: 18px;
      font-weight: 600;
    }

    .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .btn-control {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid #fbc9d8;
      background: white;
      font-size: 20px;
      color: #d81b60;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #amount {
      width: 130px;
      padding: 11px;
      font-size: 17px;
      border: 2px solid #fde0e6;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
    }

    .action-buttons {
      display: flex;
      gap: 14px;
      margin-bottom: 20px;
    }
    .action-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-add { background: #e8f5e9; color: #2e7d32; }
    .btn-remove { background: #ffebee; color: #c62828; }

    .chat-history {
      height: 180px;
      overflow-y: auto;
      padding: 12px;
      background: #fdf6fa;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      margin-bottom: 12px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.4;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.mellycia {
      align-self: flex-start;
      background: #e3f2fd;
      color: #0d47a1;
      border-bottom-left-radius: 5px;
    }
    .message.reviano {
      align-self: flex-end;
      background: #f3e5f5;
      color: #4a148c;
      border-bottom-right-radius: 5px;
    }
    .message.add { border-left: 4px solid #4caf50; }
    .message.remove { border-left: 4px solid #f44336; }
    .message.empty {
      align-self: center;
      background: transparent;
      color: #999;
      font-style: italic;
    }
    .message-time {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
      text-align: right;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="user-select-section">
      <h1>Siapa Kamu Hari Ini? ðŸ’•</h1>
      <div class="user-select">
        <button class="user-btn" data-name="Mellycia">Mellycia</button>
        <button class="user-btn" data-name="Reviano">Reviano</button>
      </div>
    </div>

    <div id="saving-section" class="saving-ui">
      <div id="total-banner">
        Total Tabungan Kita Semua ðŸ’–
        <span class="total-amount" id="total-amount">Rp0</span>
      </div>

      <div class="contributions">
        <div class="contrib-card">
          <div class="contrib-name mellycia">Mellycia</div>
          <div class="contrib-percent" id="mellycia-percent">0%</div>
          <div class="contrib-bar">
            <div class="contrib-fill mellycia" id="mellycia-bar" style="width: 0%"></div>
          </div>
        </div>
        <div class="contrib-card">
          <div class="contrib-name reviano">Reviano</div>
          <div class="contrib-percent" id="reviano-percent">0%</div>
          <div class="contrib-bar">
            <div class="contrib-fill reviano" id="reviano-bar" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <div class="header-user" id="header-user">Mellycia</div>

      <div class="input-group">
        <button class="btn-control" id="minus-amount">âˆ’</button>
        <input type="number" id="amount" placeholder="5 = 5rb" min="1" value="10"/>
        <button class="btn-control" id="plus-amount">+</button>
      </div>

      <div class="action-buttons">
        <button class="action-btn btn-add" id="add-btn">âž• Tambah</button>
        <button class="action-btn btn-remove" id="remove-btn">âž– Kurangi</button>
      </div>

      <div class="chat-history" id="chat-history">
        <div class="message empty">Belum ada aktivitas...</div>
      </div>
    </div>
  </div>

  <!-- âœ¨ AUDIO: musik.mp3 -->
  <audio id="bg-music" preload="auto" loop>
    <source src="musik.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ðŸ”Š Musik
    const bgMusic = document.getElementById('bg-music');
    let musicPlayed = false;

    function playMusicOnce() {
      if (!musicPlayed) {
        // Coba putar musik (hanya sekali)
        const playPromise = bgMusic.play();
        if (playPromise !== undefined) {
          playPromise.catch(e => {
            console.warn("Auto-play ditolak oleh browser:", e);
            // Tidak masalah â€” user tetap bisa pakai fitur
          });
        }
        musicPlayed = true;
      }
    }

    // ðŸ”¥ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCWvNYTxHXEMu66iXOSGdv1w05nyagdtFM",
      databaseURL: "https://project-594a7-default-rtdb.firebaseio.com",
      projectId: "project-594a7",
      appId: "1:395868591069:android:672766fccced8d68a65c34"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM
    const userSelectSection = document.getElementById('user-select-section');
    const savingSection = document.getElementById('saving-section');
    const userBtns = document.querySelectorAll('.user-btn');
    const headerUserEl = document.getElementById('header-user');
    const totalAmountEl = document.getElementById('total-amount');
    const amountInput = document.getElementById('amount');
    const plusBtn = document.getElementById('plus-amount');
    const minusBtn = document.getElementById('minus-amount');
    const addBtn = document.getElementById('add-btn');
    const removeBtn = document.getElementById('remove-btn');
    const chatHistory = document.getElementById('chat-history');
    const mellyciaPercentEl = document.getElementById('mellycia-percent');
    const revianoPercentEl = document.getElementById('reviano-percent');
    const mellyciaBar = document.getElementById('mellycia-bar');
    const revianoBar = document.getElementById('reviano-bar');

    let currentUserName = null;
    let isProcessing = false;

    function formatTimestamp(ts) {
      if (typeof ts !== 'number') return '';
      const date = new Date(ts);
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      const day = date.getDate();
      const month = months[date.getMonth()];
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day} ${month}, ${hours}:${minutes}`;
    }

    async function ensureUserBalance(userName) {
      const key = userName.toLowerCase();
      const snap = await db.ref(`users/${key}/balance`).once('value');
      if (snap.val() === null) {
        await db.ref(`users/${key}/balance`).set(0);
      }
    }

    function updateContribution(mellyciaBal, revianoBal) {
      const total = mellyciaBal + revianoBal;
      const mellyPct = total > 0 ? Math.round((mellyciaBal / total) * 100) : 0;
      const revPct = total > 0 ? Math.round((revianoBal / total) * 100) : 0;

      mellyciaPercentEl.textContent = `${mellyPct}%`;
      revianoPercentEl.textContent = `${revPct}%`;
      mellyciaBar.style.width = `${mellyPct}%`;
      revianoBar.style.width = `${revPct}%`;
    }

    function startListeningToHistory() {
      db.ref('history').off('child_added');
      db.ref('history')
        .orderByChild('timestamp')
        .limitToLast(50)
        .on('child_added', (snapshot) => {
          const entry = snapshot.val();
          if (!entry?.user || entry.amount === undefined || !entry.timestamp) return;

          const isAdd = entry.amount > 0;
          const amountRB = (Math.abs(entry.amount) / 1000) + 'rb';
          const actionText = `${entry.user}: ${isAdd ? 'Menambahkan +' : 'Mengambil âˆ’'}${amountRB}`;
          const timeText = formatTimestamp(entry.timestamp);
          const isMellycia = entry.user === "Mellycia";

          const msgDiv = document.createElement('div');
          msgDiv.className = `message ${isMellycia ? 'mellycia' : 'reviano'} ${isAdd ? 'add' : 'remove'}`;
          msgDiv.innerHTML = `
            ${actionText}
            <div class="message-time">${timeText}</div>
          `;

          const emptyEl = chatHistory.querySelector('.message.empty');
          if (emptyEl) emptyEl.remove();

          chatHistory.appendChild(msgDiv);
          chatHistory.scrollTop = chatHistory.scrollHeight;
        });
    }

    function listenToData() {
      db.ref('total').on('value', (snap) => {
        const total = snap.val() || 0;
        totalAmountEl.textContent = `Rp${total.toLocaleString('id-ID')}`;
      });

      let mBal = 0, rBal = 0;
      db.ref('users/mellycia/balance').on('value', (snap) => {
        mBal = snap.val() || 0;
        updateContribution(mBal, rBal);
      });
      db.ref('users/reviano/balance').on('value', (snap) => {
        rBal = snap.val() || 0;
        updateContribution(mBal, rBal);
      });
    }

    // âœ… SAAT USER KLIK MELLYCIA/REVIANO â†’ PUTAR MUSIK!
    userBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        userBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentUserName = btn.dataset.name;
        headerUserEl.textContent = currentUserName;
        userSelectSection.style.display = 'none';
        savingSection.style.display = 'block';

        // ðŸ”Š PUTAR MUSIK SAAT PILIH USER
        playMusicOnce();

        await ensureUserBalance("Mellycia");
        await ensureUserBalance("Reviano");

        listenToData();
        startListeningToHistory();
        chatHistory.innerHTML = '<div class="message empty">Memuat riwayat...</div>';
      });
    });

    plusBtn.addEventListener('click', () => {
      let val = parseInt(amountInput.value) || 0;
      amountInput.value = val + 5;
    });
    minusBtn.addEventListener('click', () => {
      let val = parseInt(amountInput.value) || 5;
      if (val > 5) amountInput.value = val - 5;
    });

    async function saveAction(isAdd) {
      if (!currentUserName || isProcessing) return;
      isProcessing = true;

      const inputVal = parseInt(amountInput.value);
      if (!inputVal || inputVal <= 0) {
        alert('Masukkan jumlah valid (contoh: 5 = 5rb)');
        isProcessing = false;
        return;
      }

      const amountInRupiah = isAdd ? inputVal * 1000 : -(inputVal * 1000);
      const userKey = currentUserName.toLowerCase();

      try {
        const userSnap = await db.ref(`users/${userKey}/balance`).once('value');
        let balance = userSnap.val() || 0;
        let newBalance = balance + amountInRupiah;
        if (newBalance < 0) newBalance = 0;

        await db.ref(`users/${userKey}/balance`).set(newBalance);

        const mSnap = await db.ref('users/mellycia/balance').once('value');
        const rSnap = await db.ref('users/reviano/balance').once('value');
        const total = (mSnap.val() || 0) + (rSnap.val() || 0);
        await db.ref('total').set(total);

        await db.ref('history').push({
          user: currentUserName,
          amount: amountInRupiah,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        amountInput.value = '10';
      } catch (error) {
        console.error("âŒ Error:", error);
        alert("Gagal menyimpan! Cek koneksi & aturan Firebase.");
      } finally {
        isProcessing = false;
      }
    }

    addBtn.addEventListener('click', () => saveAction(true));
    removeBtn.addEventListener('click', () => saveAction(false));
  </script>
</body>
</html>

